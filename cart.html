<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width", initial-scale="1.0">
    <title>Cart & Payment</title>
    <link rel="stylesheet" href="./styles/cart.css">
</head>
 <style>
        
        #bookTitle {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
        
        #payment-form button:hover {
            background: #0056b3;
        }
        #payment-form button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .error-message {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .success-message {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
    </style>
<body>
    <div id="content">
         <div class="container">
        <h1><em>Welcome to our cart page</em></h1>
        <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
        <div class="info">
            <input type="text"  id="bookTitle"  name="book-name" placeholder="Name of book" required>
            <input type="number"  id="durationDays" name="durationDays" placeholder="duration in days" required>
        </div>
        <h2><em>Place your Order</em></h2>
        <div class="books" id="books"></div>
        <h2><em>Cart</em></h2>
        <div class="cart" id="cart"></div>
        <h2><em>Payment</em></h2>
        <form id="payment-form">
            <!-- <input type="text" id="name" placeholder="Name on Card" required>
            <input type="text" id="card" placeholder="Card Number" required maxlength="16">
            <input type="text" id="expiry" placeholder="MM/YY" required maxlength="5">
            <input type="text" id="cvv" placeholder="CVV" required maxlength="3"> -->
            <button type="submit">Pay</button>
        </form>
        <h2><em>Other Payment Methods</em></h2>
        <div class="pay">
            <a href="#"><img src="./images/cart-images/4.JPG" alt="">
            <a href="#"><img src="./images/cart-images/5.JPG" alt=""></a>
            <a href="#"><img src="./images/cart-images/6.JPG" alt=""></a></a>
        </div>
        <div id="payment-message"></div>
    </div>
    </div>

    <script src="./scripts/cart.jsx"></script>
</body>



 <script>
        // API configuration
        const API_BASE_URL = 'http://127.0.0.1:8080/api';
        const BOOKS_API_URL = `${API_BASE_URL}/books`;
        const PAYMENTS_API_URL = `${API_BASE_URL}/payments`;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('bookId');

        // DOM elements - FIXED: Using correct IDs from your HTML
        const bookTitleInput = document.getElementById('bookTitle');
        const durationDaysInput = document.getElementById('durationDays');
        const paymentForm = document.getElementById('payment-form');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const payButton = paymentForm.querySelector('button[type="submit"]'); // Get the button from form

        // Function to get JWT token
        function getAuthToken() {
            return localStorage.getItem('jwt') || localStorage.getItem('token');
        }

        // Function to create headers with authentication
        function createHeaders() {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            return headers;
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        // Show success message
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        // Hide messages
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // Get book details from backend
        async function getBookDetails() {
            if (!bookId) {
                showError('No book ID provided in the URL.');
                return;
            }

            try {
                // Fetch all books and find the specific one by ID
                const response = await fetch(`${BOOKS_API_URL}?page=0&size=100`, {
                    method: 'GET',
                    headers: createHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch book details from server');
                }

                const data = await response.json();
                const books = data.content || [];
                const book = books.find(b => b.id == bookId);

                if (!book) {
                    throw new Error('Book not found in the library');
                }

                // Display book title in the input field (read-only)
                bookTitleInput.value = book.title;
                console.log('Book details loaded:', book.title);

            } catch (error) {
                console.error('Error fetching book details:', error);
                showError('Failed to load book details: ' + error.message);
                bookTitleInput.value = 'Error loading book name';
            }
        }

        // Initiate payment function - FIXED
        async function initiatePayment(event) {
            event.preventDefault(); // Prevent form submission reload
            
            if (!bookId) {
                showError('No book selected. Please go back and select a book.');
                return;
            }

            const durationDays = parseInt(durationDaysInput.value);
            if (!durationDays || durationDays < 1 || durationDays > 365) {
                showError('Please enter a valid number of days (1-365).');
                return;
            }

            // Validate authentication
            const token = getAuthToken();
            if (!token) {
                showError('Please login to make a payment.');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            hideMessages();
            payButton.disabled = true;
            payButton.textContent = 'Processing...';

            try {
                const response = await fetch(`${PAYMENTS_API_URL}/create`, {
                    method: 'POST',
                    headers: createHeaders(),
                    body: JSON.stringify({
                        bookId: parseInt(bookId),
                        durationDays: durationDays
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.sessionUrl) {
                        showSuccess('Redirecting to secure payment...');
                        console.log('Stripe session URL:', data.sessionUrl);
                        
                        // Redirect to Stripe after a short delay
                        setTimeout(() => {
                            window.location.href = data.sessionUrl;
                        }, 1500);
                    } else {
                        throw new Error('No payment session URL received from server');
                    }
                } else if (response.status === 401) {
                    throw new Error('Session expired. Please login again.');
                } else if (response.status === 400) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Invalid request. Please check your input.');
                } else {
                    throw new Error(`Payment failed with status: ${response.status}`);
                }
            } catch (error) {
                console.error('Payment initiation error:', error);
                showError('Payment failed: ' + error.message);
            } finally {
                payButton.disabled = false;
                payButton.textContent = 'Proceed to Stripe Payment';
            }
        }

        // Event listeners - FIXED
        paymentForm.addEventListener('submit', initiatePayment);

        // Add input validation for duration
        durationDaysInput.addEventListener('input', function() {
            const value = parseInt(this.value);
            if (value < 1) this.value = 1;
            if (value > 365) this.value = 365;
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Cart page loaded. Book ID from URL:', bookId);
            
            // Check authentication
            if (!getAuthToken()) {
                showError('Please login to purchase books.');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            // Load book details
            getBookDetails();

            // Debug: Log current state
            console.log('Authentication token present:', !!getAuthToken());
            console.log('Book ID from URL:', bookId);
        });
    
    </script>


</html>

